---
title: 'Check Incentives'
description: 'Get aggregated incentive calculations from multiple utility programs based on customer address and device'
openapi: 'POST /incentives'
---

<Note>
This endpoint requires API key authentication via the `x-api-key` header.

The `reference_id` is **required** and must be unique within your organization. It's used to link customers to your organization and enables faster lookups on subsequent calls.
</Note>

## Overview

This endpoint automatically:
1. Validates the API key and verifies organization access
2. Finds or creates a customer record based on operation type
3. Links the customer to your organization using the `reference_id`
4. Looks up utility programs (via address lookup or cached utilities)
5. Calculates incentives across all applicable programs
6. Optionally creates/updates application records
7. Logs API calls for auditing
8. Returns aggregated incentive data with Connect URL (if `create_application=true`)

## Operation Types

The endpoint supports two operation modes:

### Lookup Operation
**Use when**: First-time customer, new address, or when you need fresh utility data

- Requires full address information
- Geocodes the address and finds utilities
- Creates new customer if none exists with matching address
- Caches utility information for faster subsequent calls

### Refresh Operation
**Use when**: Returning customer, faster performance needed

- Uses cached utility data (no geocoding required)
- Much faster than lookup operation
- Address is optional (uses stored address if not provided)
- Can update customer address while using cached utilities

## Request Body

### Always Required Fields

- `operation_type` (required): Either `"lookup"` or `"refresh"`
- `reference_id` (required): Your internal reference ID (unique within your organization)
- `building_type` (required): One of `single_family`, `multifamily`, `commercial`
- `device_id` (required): ID of the device for which to calculate incentives

### Conditionally Required Fields

**When `operation_type="lookup"`:**

- `address` (required): Customer address object with:
  - `street_1` (required): Primary street address
  - `street_2` (optional): Apartment, suite, unit, etc.
  - `city` (required): City name
  - `state_or_province_code` (required): 2-letter state/province code
  - `postal_code` (required): ZIP/postal code
  - `country_code` (required): 2-letter ISO country code

**When `operation_type="refresh"`:**

- `address` (optional): If provided and differs from stored address, the customer's address will be updated

### Optional Fields

- `create_application` (optional): If `true`, creates application records and returns `connect_url`

## Example Request (Lookup Operation)

Use lookup for first-time customers or when you need fresh utility data:

```bash
curl -X POST \
  "https://api.incentives.leap.energy/alpha/incentives" \
  -H "x-api-key: leap_live_..." \
  -H "Content-Type: application/json" \
  -d '{
    "operation_type": "lookup",
    "reference_id": "external-ref-123",
    "address": {
      "street_1": "123 Main St",
      "street_2": "Apt 4B",
      "city": "San Francisco",
      "state_or_province_code": "CA",
      "postal_code": "94102",
      "country_code": "US"
    },
    "building_type": "single_family",
    "device_id": 42,
    "create_application": true
  }'
```

## Example Request (Refresh Operation)

Use refresh for returning customers - much faster using cached utilities:

```bash
curl -X POST \
  "https://api.incentives.leap.energy/alpha/incentives" \
  -H "x-api-key: leap_live_..." \
  -H "Content-Type: application/json" \
  -d '{
    "operation_type": "refresh",
    "reference_id": "external-ref-123",
    "building_type": "single_family",
    "device_id": 42,
    "create_application": true
  }'
```

## Example Response

```json
{
  "utility": {
    "eiaid": 12345,
    "name": "Pacific Gas & Electric"
  },
  "possible_utilities": [
    {
      "eiaid": "12345",
      "name": "Pacific Gas & Electric"
    }
  ],
  "address": "123 Main St, San Francisco, CA 94102",
  "building_type": "single_family",
  "customer_id": 789,
  "reference_id": "external-ref-123",
  "programs_evaluated": 3,
  "incentives": {
    "total_incentive_amount": 5500,
    "total_eligible_combinations": 2,
    "by_program": [
      {
        "program_id": 101,
        "program_name": "Home Upgrade Program",
        "total_incentive": 3000,
        "eligible_combinations": 1,
        "device_tier_results": [
          {
            "device_id": 42,
            "device_name": "Heat Pump",
            "tier_id": 1,
            "tier_name": "Standard",
            "eligible": true,
            "incentive_amount": 3000,
            "calculation_details": "Base incentive for heat pump installation",
            "failed_requirements": [],
            "ignored_requirements": [],
            "completed_requirements": [
              "Income verification",
              "Building type check"
            ]
          }
        ]
      }
    ]
  },
  "connect_url": "https://connect.incentives.leap.energy/your-company/refId/external-ref-123"
}
```

## Response Fields

- `utility`: Primary utility serving the address (eiaid, name)
- `possible_utilities`: List of all possible utilities for this address
- `address`: Formatted address string
- `building_type`: Building type that was queried
- `customer_id`: Customer ID (created or found)
- `reference_id`: Your reference ID from the request
- `programs_evaluated`: Number of programs that were evaluated
- `incentives`: Aggregated incentive data
  - `total_incentive_amount`: Sum of all eligible incentives
  - `total_eligible_combinations`: Total number of eligible device/tier combinations
  - `by_program`: Array of program results with device/tier details
- `connect_url`: URL to connect/apply (only if `create_application=true`)

## Error Responses

**400 Bad Request** - Invalid or empty JSON:
```json
{
  "error": "Invalid or empty JSON body"
}
```

**400 Bad Request** - Missing required fields:
```json
{
  "error": "Missing required field: operation_type or reference_id"
}
```

**400 Bad Request** - Invalid operation_type:
```json
{
  "error": "Invalid operation_type. Must be either \"lookup\" or \"refresh\""
}
```

**400 Bad Request** - Missing address for lookup operation:
```json
{
  "error": "For lookup operation, address fields are required: street_1, city, state_or_province_code, postal_code, country_code, building_type, device_id"
}
```

**400 Bad Request** - Organization company not configured:
```json
{
  "error": "Organization company should be set for your organization. Please contact Leap to set this up"
}
```

**400 Bad Request** - Invalid building type:
```json
{
  "error": "Invalid building_type: single_family. Must be one of: RESIDENTIAL, MULTIFAMILY, MANUFACTURED_HOME, COMMERCIAL"
}
```

**400 Bad Request** - Reference ID mismatch:
```json
{
  "error": "Reference ID mismatch. The customer is linked to this organization with a different reference_id. Expected: old-ref-123, Received: new-ref-456"
}
```

**401 Unauthorized** - Missing API key:
```json
{
  "error": "Missing x-api-key header"
}
```

**403 Forbidden** - Invalid API key:
```json
{
  "error": "Invalid API key"
}
```

**403 Forbidden** - Expired API key:
```json
{
  "error": "API key has expired"
}
```

**403 Forbidden** - IP not allowed:
```json
{
  "error": "IP address not allowed"
}
```

**404 Not Found** - No utility found:
```json
{
  "error": "Program lookup failed - no utility found"
}
```

**500 Internal Server Error**:
```json
{
  "error": "Internal server error"
}
```

## Security & Organization Isolation

<Warning>
All API operations are automatically scoped to your organization:
- Customers are linked to your organization via `customer_organizations` table
- Reference IDs are unique within your organization (same reference_id can exist in different organizations)
- Cross-organization access is prevented by Row Level Security (RLS) policies
- API calls are logged for auditing in the `incentive_api_logs` table
</Warning>

<Tip>
**Performance Tip**: Use `operation_type="refresh"` for returning customers to skip geocoding and use cached utility data. This is significantly faster than lookup operations.

The `reference_id` links the customer to your organization and enables fast lookups. To manage applications later, use the application endpoints with the `application_id`.
</Tip>

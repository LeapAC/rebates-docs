{
  "openapi": "3.0.3",
  "info": {
    "title": "Batch Lookups API",
    "description": "The Batch Lookups API enables processing large volumes of incentive lookups via a **queue-based system**. Upload CSV data as batch jobs, track progress, and retrieve results. When your organization has a **webhook URL** configured (see Webhook Config API), the backend sends a POST to that URL after each successful lookup with the incentive result and any per-item custom fields.\n\n## Overview\n\nThis API provides:\n- **Batch Job Creation**: Upload multiple addresses as a single batch job (optionally with `webhook_custom_fields` per item for webhook payloads)\n- **Queue System**: Items are written to a database queue; a background worker processes them asynchronously\n- **Queue Processing**: Worker runs every 5 minutes, processing items in batches of 10 with rate limiting\n- **Progress Tracking**: Monitor job status and individual item results via GET job and GET items\n- **Automatic Reports**: Completed jobs automatically generate incentive reports\n- **Webhooks**: If webhook URL is set, each completed item triggers a POST to your URL with the incentive response plus custom fields\n\n## Authentication\n\nAll endpoints require authentication via:\n- **API Key**: `x-api-key: leap_live_<your_api_key>`\n- **Clerk Bearer Token**: `Authorization: Bearer <clerk_jwt_token>`\n\n## Queue Processing\n\nBatch jobs are processed automatically by a background worker that runs every 5 minutes. Items are processed in batches of 10, with rate limiting between requests. You can also manually trigger the worker if needed.\n\n## Rate Limits\n\n- Worker processes 10 items per run\n- 100ms delay between items\n- Maximum 3 retry attempts per failed item\n\n## Status Flow\n\n```\npending → processing → completed/failed\n```\n\nJob status:\n- `pending`: Job created, items queued\n- `processing`: Items being processed\n- `completed`: All items processed successfully\n- `failed`: All items failed\n- `cancelled`: Job was cancelled\n\nItem status:\n- `pending`: Waiting to be processed\n- `processing`: Currently being processed\n- `completed`: Successfully processed\n- `failed`: Failed after max retries",
    "version": "1.0.0",
    "contact": {
      "name": "Leap Energy",
      "url": "https://leap.energy"
    }
  },
  "servers": [
    {
      "url": "https://api.incentives.leap.energy/alpha",
      "description": "Production API"
    },
    {
      "url": "http://127.0.0.1:54321/functions/v1",
      "description": "Local Development"
    }
  ],
  "security": [
    {
      "ApiKeyAuth": []
    },
    {
      "BearerAuth": []
    }
  ],
  "components": {
    "securitySchemes": {
      "ApiKeyAuth": {
        "type": "apiKey",
        "in": "header",
        "name": "x-api-key",
        "description": "API key for partner integrations. Format: `leap_live_<64_hex_chars>`"
      },
      "BearerAuth": {
        "type": "http",
        "scheme": "bearer",
        "bearerFormat": "JWT",
        "description": "Clerk JWT token for portal authentication"
      }
    },
    "schemas": {
      "Address": {
        "type": "object",
        "required": ["street_1", "city", "state_or_province_code", "postal_code", "country_code"],
        "properties": {
          "street_1": {
            "type": "string",
            "description": "Primary street address",
            "example": "123 Main Street"
          },
          "street_2": {
            "type": "string",
            "description": "Secondary address line (apartment, suite, etc.)",
            "example": "Apt 4B"
          },
          "city": {
            "type": "string",
            "description": "City name",
            "example": "San Francisco"
          },
          "state_or_province_code": {
            "type": "string",
            "description": "State or province code (2-letter code for US states)",
            "example": "CA"
          },
          "postal_code": {
            "type": "string",
            "description": "ZIP or postal code",
            "example": "94102"
          },
          "country_code": {
            "type": "string",
            "description": "ISO 3166-1 alpha-2 country code",
            "example": "US"
          }
        }
      },
      "BatchLookupItem": {
        "type": "object",
        "required": ["reference_id", "address", "building_type", "device_ids"],
        "properties": {
          "reference_id": {
            "type": "string",
            "description": "Your unique identifier for this customer/address (e.g., deal ID, customer ID)",
            "example": "deal-12345"
          },
          "address": {
            "$ref": "#/components/schemas/Address"
          },
          "building_type": {
            "type": "string",
            "enum": ["RESIDENTIAL", "COMMERCIAL", "MULTIFAMILY"],
            "description": "Type of building",
            "example": "RESIDENTIAL"
          },
          "device_ids": {
            "type": "array",
            "items": {
              "type": "integer"
            },
            "description": "Array of device IDs to evaluate for this specific address. Each item can have different devices.",
            "minItems": 1,
            "example": [1, 2]
          },
          "create_application": {
            "type": "boolean",
            "description": "Whether to create an application if customer is eligible (optional, defaults to false)",
            "default": false,
            "example": false
          },
          "webhook_custom_fields": {
            "type": "object",
            "additionalProperties": { "type": "string" },
            "description": "Optional per-item custom fields to include in the webhook payload when your organization has a webhook URL configured (e.g. Project ID, Record ID from CSV). Each completed lookup triggers a POST to your webhook with the incentive result plus these fields.",
            "example": { "Project ID": "proj-123", "Record ID": "row-5" }
          }
        }
      },
      "CreateBatchRequest": {
        "type": "object",
        "required": ["items"],
        "properties": {
          "items": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/BatchLookupItem"
            },
            "description": "Array of lookup items. Each item will be processed independently.",
            "minItems": 1,
            "maxItems": 10000,
            "example": [
              {
                "reference_id": "deal-001",
                "address": {
                  "street_1": "123 Main St",
                  "city": "San Francisco",
                  "state_or_province_code": "CA",
                  "postal_code": "94102",
                  "country_code": "US"
                },
                "building_type": "RESIDENTIAL",
                "device_ids": [1],
                "create_application": false
              }
            ]
          }
        }
      },
      "CreateBatchResponse": {
        "type": "object",
        "properties": {
          "job_id": {
            "type": "string",
            "format": "uuid",
            "description": "Unique identifier for the batch job",
            "example": "550e8400-e29b-41d4-a716-446655440000"
          },
          "status": {
            "type": "string",
            "enum": ["pending"],
            "description": "Initial job status",
            "example": "pending"
          },
          "total_items": {
            "type": "integer",
            "description": "Total number of items in the batch",
            "example": 100
          },
          "created_at": {
            "type": "string",
            "format": "date-time",
            "description": "When the job was created",
            "example": "2026-01-26T15:30:00.000Z"
          },
          "report": {
            "type": "object",
            "description": "Incentive report created for this batch job. Sites will be added incrementally as items complete.",
            "properties": {
              "id": {
                "type": "string",
                "format": "uuid",
                "description": "Report ID",
                "example": "660e8400-e29b-41d4-a716-446655440001"
              },
              "name": {
                "type": "string",
                "description": "Report name",
                "example": "Batch Lookup - 2026-01-26 (100 sites)"
              },
              "description": {
                "type": "string",
                "nullable": true,
                "description": "Report description",
                "example": "Batch lookup job with 100 items. Sites will be added as processing completes."
              },
              "status": {
                "type": "string",
                "enum": ["processing"],
                "description": "Report status (starts as 'processing', updates to 'complete' when job finishes)",
                "example": "processing"
              },
              "report_type": {
                "type": "string",
                "enum": ["bulk_lookup"],
                "description": "Type of report",
                "example": "bulk_lookup"
              },
              "total_sites": {
                "type": "integer",
                "description": "Number of sites in report (initially 0, increases as items complete)",
                "example": 0
              },
              "created_at": {
                "type": "string",
                "format": "date-time",
                "description": "When the report was created",
                "example": "2026-01-26T15:30:00.000Z"
              }
            },
            "required": ["id", "name", "status", "report_type", "total_sites", "created_at"]
          },
          "message": {
            "type": "string",
            "description": "Human-readable message",
            "example": "Batch job created with 100 items. Report is available immediately and sites will be added as processing completes. Poll GET /batch-lookups/{job_id} for job status."
          }
        },
        "required": ["job_id", "status", "total_items", "created_at", "report", "message"]
      },
      "BatchJob": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "description": "Job ID",
            "example": "550e8400-e29b-41d4-a716-446655440000"
          },
          "organization_id": {
            "type": "string",
            "format": "uuid",
            "description": "Organization that owns this job"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "processing", "completed", "failed", "cancelled"],
            "description": "Current job status"
          },
          "total_items": {
            "type": "integer",
            "description": "Total items in the batch"
          },
          "processed_items": {
            "type": "integer",
            "description": "Number of items processed (completed + failed)"
          },
          "failed_items": {
            "type": "integer",
            "description": "Number of items that failed"
          },
          "report_id": {
            "type": "string",
            "format": "uuid",
            "nullable": true,
            "description": "ID of the incentive report created when job completes (if any)"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "started_at": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "description": "When processing started"
          },
          "completed_at": {
            "type": "string",
            "format": "date-time",
            "nullable": true,
            "description": "When processing completed"
          },
          "item_counts": {
            "type": "object",
            "properties": {
              "pending": {
                "type": "integer",
                "description": "Items waiting to be processed"
              },
              "processing": {
                "type": "integer",
                "description": "Items currently being processed"
              },
              "completed": {
                "type": "integer",
                "description": "Items successfully processed"
              },
              "failed": {
                "type": "integer",
                "description": "Items that failed after retries"
              }
            }
          }
        }
      },
      "QueueItem": {
        "type": "object",
        "properties": {
          "id": {
            "type": "string",
            "format": "uuid",
            "description": "Queue item ID"
          },
          "job_id": {
            "type": "string",
            "format": "uuid",
            "description": "Parent batch job ID"
          },
          "organization_id": {
            "type": "string",
            "format": "uuid"
          },
          "status": {
            "type": "string",
            "enum": ["pending", "processing", "completed", "failed"],
            "description": "Current item status"
          },
          "reference_id": {
            "type": "string",
            "description": "Your reference ID for this item"
          },
          "address": {
            "$ref": "#/components/schemas/Address",
            "description": "Address object (original from request)"
          },
          "building_type": {
            "type": "string",
            "enum": ["RESIDENTIAL", "COMMERCIAL", "MULTIFAMILY"]
          },
          "device_ids": {
            "type": "array",
            "items": {
              "type": "integer"
            },
            "description": "Device IDs evaluated for this item"
          },
          "create_application": {
            "type": "boolean"
          },
          "webhook_custom_fields": {
            "type": "object",
            "additionalProperties": { "type": "string" },
            "nullable": true,
            "description": "Per-item custom fields sent with the request; included in webhook payload when org has webhook URL configured"
          },
          "result": {
            "type": "object",
            "nullable": true,
            "description": "Full API response from /incentives endpoint (when completed)",
            "properties": {
              "customer_id": {
                "type": "integer"
              },
              "utility": {
                "type": "object",
                "properties": {
                  "name": {
                    "type": "string"
                  },
                  "eiaid": {
                    "type": "string"
                  }
                }
              },
              "address": {
                "type": "string",
                "description": "Formatted address string"
              },
              "incentives": {
                "type": "object",
                "properties": {
                  "total_incentive_amount": {
                    "type": "number"
                  },
                  "by_program": {
                    "type": "array",
                    "items": {
                      "type": "object"
                    }
                  }
                }
              },
              "connect_url": {
                "type": "string",
                "nullable": true
              }
            }
          },
          "error_message": {
            "type": "string",
            "nullable": true,
            "description": "Error message if item failed"
          },
          "retry_count": {
            "type": "integer",
            "description": "Number of retry attempts"
          },
          "created_at": {
            "type": "string",
            "format": "date-time"
          },
          "processed_at": {
            "type": "string",
            "format": "date-time",
            "nullable": true
          }
        }
      },
      "JobListResponse": {
        "type": "object",
        "properties": {
          "jobs": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/BatchJob"
            }
          },
          "total": {
            "type": "integer",
            "description": "Total number of jobs matching filters"
          },
          "limit": {
            "type": "integer"
          },
          "offset": {
            "type": "integer"
          }
        }
      },
      "ItemListResponse": {
        "type": "object",
        "properties": {
          "items": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/QueueItem"
            }
          },
          "total": {
            "type": "integer",
            "description": "Total number of items matching filters"
          },
          "limit": {
            "type": "integer"
          },
          "offset": {
            "type": "integer"
          }
        }
      },
      "Error": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "description": "Error message"
          },
          "invalid_items": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "index": {
                  "type": "integer"
                },
                "error": {
                  "type": "string"
                }
              }
            },
            "description": "Details about invalid items (when creating batch)"
          },
          "duplicates": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Duplicate reference_ids found (when creating batch)"
          }
        }
      },
      "CancelJobResponse": {
        "type": "object",
        "properties": {
          "message": {
            "type": "string",
            "example": "Job cancelled successfully"
          },
          "job_id": {
            "type": "string",
            "format": "uuid"
          }
        }
      }
    }
  },
  "paths": {
    "/batch-lookups": {
      "post": {
        "summary": "Create Batch Job",
        "description": "Create a new batch job with multiple lookup items. Each item will be processed independently with its own device_ids.\n\n**Processing:**\n- Items are queued immediately with status `pending`\n- Background worker processes items automatically (every 5 minutes)\n- You can poll the job status or manually trigger the worker\n\n**Validation:**\n- All items are validated before job creation\n- Duplicate `reference_id` values within a batch are rejected\n- Invalid items are reported with specific error messages\n\n**Limits:**\n- Maximum 10,000 items per batch\n- Each item can have different `device_ids`\n- Each item can have different `create_application` setting",
        "operationId": "createBatchJob",
        "tags": ["Batch Lookups"],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CreateBatchRequest"
              },
              "examples": {
                "simple": {
                  "summary": "Simple batch with 2 items",
                  "value": {
                    "items": [
                      {
                        "reference_id": "deal-001",
                        "address": {
                          "street_1": "123 Main St",
                          "city": "San Francisco",
                          "state_or_province_code": "CA",
                          "postal_code": "94102",
                          "country_code": "US"
                        },
                        "building_type": "RESIDENTIAL",
                        "device_ids": [1],
                        "create_application": false
                      },
                      {
                        "reference_id": "deal-002",
                        "address": {
                          "street_1": "456 Oak Ave",
                          "city": "Los Angeles",
                          "state_or_province_code": "CA",
                          "postal_code": "90001",
                          "country_code": "US"
                        },
                        "building_type": "RESIDENTIAL",
                        "device_ids": [1, 2],
                        "create_application": true
                      }
                    ]
                  }
                },
                "csv_upload": {
                  "summary": "Typical CSV upload scenario",
                  "description": "When uploading a CSV, parse rows and create items array",
                  "value": {
                    "items": [
                      {
                        "reference_id": "csv-row-1",
                        "address": {
                          "street_1": "789 Pine Rd",
                          "city": "Portland",
                          "state_or_province_code": "OR",
                          "postal_code": "97201",
                          "country_code": "US"
                        },
                        "building_type": "RESIDENTIAL",
                        "device_ids": [1]
                      }
                    ]
                  }
                },
                "with_webhook_fields": {
                  "summary": "Batch with webhook custom fields",
                  "description": "Include custom fields per item for webhook payloads when org has webhook URL configured",
                  "value": {
                    "items": [
                      {
                        "reference_id": "deal-001",
                        "address": {
                          "street_1": "123 Main St",
                          "city": "San Francisco",
                          "state_or_province_code": "CA",
                          "postal_code": "94102",
                          "country_code": "US"
                        },
                        "building_type": "RESIDENTIAL",
                        "device_ids": [1],
                        "webhook_custom_fields": {
                          "Project ID": "proj-456",
                          "Record ID": "row-1"
                        }
                      }
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Batch job created successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CreateBatchResponse"
                },
                "example": {
                  "job_id": "550e8400-e29b-41d4-a716-446655440000",
                  "status": "pending",
                  "total_items": 100,
                  "created_at": "2026-01-26T15:30:00.000Z",
                  "report": {
                    "id": "660e8400-e29b-41d4-a716-446655440001",
                    "name": "Batch Lookup - 2026-01-26 (100 sites)",
                    "description": "Batch lookup job with 100 items. Sites will be added as processing completes.",
                    "status": "processing",
                    "report_type": "bulk_lookup",
                    "total_sites": 0,
                    "created_at": "2026-01-26T15:30:00.000Z"
                  },
                  "message": "Batch job created with 100 items. Report is available immediately and sites will be added as processing completes. Poll GET /batch-lookups/{job_id} for job status."
                }
              }
            }
          },
          "400": {
            "description": "Validation error",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                },
                "examples": {
                  "missing_items": {
                    "value": {
                      "error": "items array is required and must contain at least one lookup item"
                    }
                  },
                  "invalid_items": {
                    "value": {
                      "error": "5 item(s) failed validation",
                      "invalid_items": [
                        {
                          "index": 0,
                          "error": "Missing required fields (reference_id, address with street_1/city/state/postal/country, building_type, device_ids array)"
                        }
                      ],
                      "total_invalid": 5
                    }
                  },
                  "duplicates": {
                    "value": {
                      "error": "Duplicate reference_ids found in batch",
                      "duplicates": ["deal-001", "deal-002"]
                    }
                  }
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized - missing or invalid authentication"
          },
          "500": {
            "description": "Internal server error"
          }
        },
        "x-codeSamples": [
          {
            "lang": "curl",
            "label": "cURL",
            "source": "curl -X POST \\\n  \"https://api.incentives.leap.energy/alpha/batch-lookups\" \\\n  -H \"x-api-key: leap_live_...\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"items\": [\n      {\n        \"reference_id\": \"deal-001\",\n        \"address\": {\n          \"street_1\": \"123 Main St\",\n          \"city\": \"San Francisco\",\n          \"state_or_province_code\": \"CA\",\n          \"postal_code\": \"94102\",\n          \"country_code\": \"US\"\n        },\n        \"building_type\": \"RESIDENTIAL\",\n        \"device_ids\": [1]\n      }\n    ]\n  }'"
          },
          {
            "lang": "javascript",
            "label": "JavaScript",
            "source": "const response = await fetch('https://api.incentives.leap.energy/alpha/batch-lookups', {\n  method: 'POST',\n  headers: {\n    'x-api-key': 'leap_live_...',\n    'Content-Type': 'application/json'\n  },\n  body: JSON.stringify({\n    items: [\n      {\n        reference_id: 'deal-001',\n        address: {\n          street_1: '123 Main St',\n          city: 'San Francisco',\n          state_or_province_code: 'CA',\n          postal_code: '94102',\n          country_code: 'US'\n        },\n        building_type: 'RESIDENTIAL',\n        device_ids: [1]\n      }\n    ]\n  })\n});\n\nconst data = await response.json();\nconsole.log('Job ID:', data.job_id);"
          },
          {
            "lang": "python",
            "label": "Python",
            "source": "import requests\n\nurl = 'https://api.incentives.leap.energy/alpha/batch-lookups'\nheaders = {\n    'x-api-key': 'leap_live_...',\n    'Content-Type': 'application/json'\n}\npayload = {\n    'items': [\n        {\n            'reference_id': 'deal-001',\n            'address': {\n                'street_1': '123 Main St',\n                'city': 'San Francisco',\n                'state_or_province_code': 'CA',\n                'postal_code': '94102',\n                'country_code': 'US'\n            },\n            'building_type': 'RESIDENTIAL',\n            'device_ids': [1]\n        }\n    ]\n}\n\nresponse = requests.post(url, json=payload, headers=headers)\ndata = response.json()\nprint(f'Job ID: {data[\"job_id\"]}')"
          }
        ]
      },
      "get": {
        "summary": "List Batch Jobs",
        "description": "List all batch jobs for your organization with optional filtering and pagination.\n\n**Filtering:**\n- Filter by `status` to see only pending, completed, or failed jobs\n- Results are automatically scoped to your organization\n\n**Pagination:**\n- Use `limit` and `offset` for pagination\n- Default limit is 20, maximum is 200",
        "operationId": "listBatchJobs",
        "tags": ["Batch Lookups"],
        "parameters": [
          {
            "name": "status",
            "in": "query",
            "description": "Filter by job status",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["pending", "processing", "completed", "failed", "cancelled"]
            }
          },
          {
            "name": "limit",
            "in": "query",
            "description": "Maximum number of results to return",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 20,
              "minimum": 1,
              "maximum": 200
            }
          },
          {
            "name": "offset",
            "in": "query",
            "description": "Number of results to skip (for pagination)",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 0,
              "minimum": 0
            }
          }
        ],
        "responses": {
          "200": {
            "description": "List of batch jobs",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/JobListResponse"
                },
                "example": {
                  "jobs": [
                    {
                      "id": "550e8400-e29b-41d4-a716-446655440000",
                      "status": "completed",
                      "total_items": 100,
                      "processed_items": 100,
                      "failed_items": 0,
                      "created_at": "2026-01-26T15:30:00.000Z",
                      "completed_at": "2026-01-26T15:35:00.000Z"
                    }
                  ],
                  "total": 1,
                  "limit": 20,
                  "offset": 0
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized"
          },
          "500": {
            "description": "Internal server error"
          }
        },
        "x-codeSamples": [
          {
            "lang": "curl",
            "label": "cURL",
            "source": "curl -X GET \\\n  \"https://api.incentives.leap.energy/alpha/batch-lookups?status=completed&limit=20\" \\\n  -H \"x-api-key: leap_live_...\""
          }
        ]
      }
    },
    "/batch-lookups/{job_id}": {
      "get": {
        "summary": "Get Batch Job Status",
        "description": "Get detailed status and progress for a specific batch job.\n\n**Response includes:**\n- Overall job status and progress counters\n- Item status breakdown (pending, processing, completed, failed)\n- Timestamps (created, started, completed)\n- Link to incentive report (if job completed)\n\n**Optional:**\n- Set `include_items=true` to include full item details in response",
        "operationId": "getBatchJob",
        "tags": ["Batch Lookups"],
        "parameters": [
          {
            "name": "job_id",
            "in": "path",
            "required": true,
            "description": "Batch job UUID",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "include_items",
            "in": "query",
            "description": "Include full item details in response (default: false)",
            "required": false,
            "schema": {
              "type": "boolean",
              "default": false
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Job details",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/BatchJob"
                },
                "examples": {
                  "pending": {
                    "summary": "Pending job",
                    "value": {
                      "id": "550e8400-e29b-41d4-a716-446655440000",
                      "status": "pending",
                      "total_items": 100,
                      "processed_items": 0,
                      "failed_items": 0,
                      "created_at": "2026-01-26T15:30:00.000Z",
                      "started_at": null,
                      "completed_at": null,
                      "item_counts": {
                        "pending": 100,
                        "processing": 0,
                        "completed": 0,
                        "failed": 0
                      }
                    }
                  },
                  "processing": {
                    "summary": "Job in progress",
                    "value": {
                      "id": "550e8400-e29b-41d4-a716-446655440000",
                      "status": "processing",
                      "total_items": 100,
                      "processed_items": 45,
                      "failed_items": 2,
                      "created_at": "2026-01-26T15:30:00.000Z",
                      "started_at": "2026-01-26T15:31:00.000Z",
                      "completed_at": null,
                      "item_counts": {
                        "pending": 50,
                        "processing": 5,
                        "completed": 43,
                        "failed": 2
                      }
                    }
                  },
                  "completed": {
                    "summary": "Completed job",
                    "value": {
                      "id": "550e8400-e29b-41d4-a716-446655440000",
                      "status": "completed",
                      "total_items": 100,
                      "processed_items": 100,
                      "failed_items": 0,
                      "report_id": "660e8400-e29b-41d4-a716-446655440001",
                      "created_at": "2026-01-26T15:30:00.000Z",
                      "started_at": "2026-01-26T15:31:00.000Z",
                      "completed_at": "2026-01-26T15:35:00.000Z",
                      "item_counts": {
                        "pending": 0,
                        "processing": 0,
                        "completed": 100,
                        "failed": 0
                      }
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Job not found",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                },
                "example": {
                  "error": "Batch job not found"
                }
              }
            }
          },
          "401": {
            "description": "Unauthorized"
          }
        },
        "x-codeSamples": [
          {
            "lang": "curl",
            "label": "cURL",
            "source": "curl -X GET \\\n  \"https://api.incentives.leap.energy/alpha/batch-lookups/550e8400-e29b-41d4-a716-446655440000\" \\\n  -H \"x-api-key: leap_live_...\""
          },
          {
            "lang": "javascript",
            "label": "JavaScript (Polling)",
            "source": "async function pollJobStatus(jobId) {\n  const pollInterval = 5000; // 5 seconds\n  \n  while (true) {\n    const response = await fetch(\n      `https://api.incentives.leap.energy/alpha/batch-lookups/${jobId}`,\n      {\n        headers: { 'x-api-key': 'leap_live_...' }\n      }\n    );\n    \n    const job = await response.json();\n    \n    if (job.status === 'completed' || job.status === 'failed') {\n      return job;\n    }\n    \n    console.log(`Progress: ${job.processed_items}/${job.total_items}`);\n    await new Promise(resolve => setTimeout(resolve, pollInterval));\n  }\n}"
          }
        ]
      }
    },
    "/batch-lookups/{job_id}/items": {
      "get": {
        "summary": "Get Batch Job Items",
        "description": "Get all items (lookups) for a batch job with optional filtering and pagination.\n\n**Use cases:**\n- View individual lookup results\n- Export results to CSV\n- Filter by status (completed, failed, pending)\n- Get detailed error messages for failed items\n\n**Response includes:**\n- Full address information\n- Device IDs evaluated\n- Complete API response (`result` field)\n- Error messages for failed items\n- Processing timestamps",
        "operationId": "getBatchJobItems",
        "tags": ["Batch Lookups"],
        "parameters": [
          {
            "name": "job_id",
            "in": "path",
            "required": true,
            "description": "Batch job UUID",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          },
          {
            "name": "status",
            "in": "query",
            "description": "Filter items by status",
            "required": false,
            "schema": {
              "type": "string",
              "enum": ["pending", "processing", "completed", "failed"]
            }
          },
          {
            "name": "limit",
            "in": "query",
            "description": "Maximum number of items to return",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 50,
              "minimum": 1,
              "maximum": 500
            }
          },
          {
            "name": "offset",
            "in": "query",
            "description": "Number of items to skip (for pagination)",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 0,
              "minimum": 0
            }
          }
        ],
        "responses": {
          "200": {
            "description": "List of queue items",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ItemListResponse"
                },
                "examples": {
                  "completed_items": {
                    "summary": "Completed items with results",
                    "value": {
                      "items": [
                        {
                          "id": "770e8400-e29b-41d4-a716-446655440000",
                          "job_id": "550e8400-e29b-41d4-a716-446655440000",
                          "status": "completed",
                          "reference_id": "deal-001",
                          "address": {
                            "street_1": "123 Main St",
                            "city": "San Francisco",
                            "state_or_province_code": "CA",
                            "postal_code": "94102",
                            "country_code": "US"
                          },
                          "building_type": "RESIDENTIAL",
                          "device_ids": [1],
                          "result": {
                            "customer_id": 1234,
                            "utility": {
                              "name": "PACIFIC GAS & ELECTRIC COMPANY",
                              "eiaid": "14328"
                            },
                            "incentives": {
                              "total_incentive_amount": 1500.00,
                              "by_program": []
                            }
                          },
                          "error_message": null,
                          "retry_count": 0,
                          "created_at": "2026-01-26T15:30:00.000Z",
                          "processed_at": "2026-01-26T15:31:05.000Z"
                        }
                      ],
                      "total": 100,
                      "limit": 50,
                      "offset": 0
                    }
                  },
                  "failed_items": {
                    "summary": "Failed items with errors",
                    "value": {
                      "items": [
                        {
                          "id": "880e8400-e29b-41d4-a716-446655440000",
                          "status": "failed",
                          "reference_id": "deal-002",
                          "error_message": "Failed to fetch program lookup data",
                          "retry_count": 3
                        }
                      ],
                      "total": 5,
                      "limit": 50,
                      "offset": 0
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Job not found"
          },
          "401": {
            "description": "Unauthorized"
          }
        },
        "x-codeSamples": [
          {
            "lang": "curl",
            "label": "cURL",
            "source": "curl -X GET \\\n  \"https://api.incentives.leap.energy/alpha/batch-lookups/550e8400-e29b-41d4-a716-446655440000/items?status=completed\" \\\n  -H \"x-api-key: leap_live_...\""
          },
          {
            "lang": "javascript",
            "label": "JavaScript (Export to CSV)",
            "source": "async function exportJobResults(jobId) {\n  const response = await fetch(\n    `https://api.incentives.leap.energy/alpha/batch-lookups/${jobId}/items?status=completed&limit=500`,\n    { headers: { 'x-api-key': 'leap_live_...' } }\n  );\n  \n  const data = await response.json();\n  \n  // Convert to CSV\n  const csv = [\n    'reference_id,customer_id,utility,total_incentive,status',\n    ...data.items.map(item => [\n      item.reference_id,\n      item.result?.customer_id || '',\n      item.result?.utility?.name || '',\n      item.result?.incentives?.total_incentive_amount || 0,\n      item.status\n    ].join(','))\n  ].join('\\n');\n  \n  return csv;\n}"
          }
        ]
      }
    },
    "/batch-lookups/{job_id}/cancel": {
      "post": {
        "summary": "Cancel Batch Job",
        "description": "Cancel a pending or processing batch job.\n\n**Behavior:**\n- Only `pending` or `processing` jobs can be cancelled\n- Cancelled jobs cannot be resumed\n- Pending items are marked as `failed` with error 'Job cancelled'\n- Processing items are allowed to complete\n\n**Use cases:**\n- Stop processing if you uploaded wrong data\n- Cancel long-running jobs\n- Free up queue capacity",
        "operationId": "cancelBatchJob",
        "tags": ["Batch Lookups"],
        "parameters": [
          {
            "name": "job_id",
            "in": "path",
            "required": true,
            "description": "Batch job UUID",
            "schema": {
              "type": "string",
              "format": "uuid"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Job cancelled successfully",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/CancelJobResponse"
                },
                "example": {
                  "message": "Job cancelled successfully",
                  "job_id": "550e8400-e29b-41d4-a716-446655440000"
                }
              }
            }
          },
          "400": {
            "description": "Cannot cancel job (already completed/failed/cancelled)",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/Error"
                },
                "example": {
                  "error": "Cannot cancel job with status 'completed'. Only pending or processing jobs can be cancelled."
                }
              }
            }
          },
          "404": {
            "description": "Job not found"
          },
          "401": {
            "description": "Unauthorized"
          }
        },
        "x-codeSamples": [
          {
            "lang": "curl",
            "label": "cURL",
            "source": "curl -X POST \\\n  \"https://api.incentives.leap.energy/alpha/batch-lookups/550e8400-e29b-41d4-a716-446655440000/cancel\" \\\n  -H \"x-api-key: leap_live_...\""
          }
        ]
      }
    }
  }
}
